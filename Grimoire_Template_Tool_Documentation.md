## Документация по разработке инструмента "Генератор Шаблонов" в проекте Grimoire

**Дата:** 25 сентября 2025 г.
**Проект:** Grimoire (Kotlin Multiplatform, Compose Desktop)
**Цель:** Расширение функционала утилиты для работы с шаблонами.

---

### 1. Инструмент "Шаблоны" (Templates Tool)

**Исходная задача:** Создать инструмент для навигации по файлам шаблонов (`.vm`) и их редактирования.

**Реализованный функционал:**

*   **Навигация по файлам:** Пользователь может просматривать структуру папок `C:\src\Synced\Grimoire\Templates` и выбирать файлы шаблонов.
*   **Редактирование шаблона (Single File Generation):**
    *   **Парсинг переменных Velocity:** При выборе шаблона, приложение анализирует его содержимое и извлекает все переменные Velocity (например, `$name`, `${color}`).
    *   **Динамическая форма ввода:** Для каждой извлеченной переменной генерируется поле ввода (`TextField`).
    *   **Значения по умолчанию:** Поддерживается директива `## @default(variableName="defaultValue")` внутри шаблона. Если такая директива найдена, соответствующее поле ввода заполняется значением по умолчанию.
    *   **Рендеринг шаблона:** Кнопка "Применить" (Apply) подставляет введенные пользователем значения в шаблон и отображает результат в отдельном поле вывода.
    *   **Сохранение файла:** Кнопка "Сохранить" сохраняет отрендеренный контент в указанную в настройках папку.
        *   Если в переменных присутствует `packageName`, файл сохраняется с учетом структуры пакетов (например, `save_path/com/example/MyClass.kt`).
        *   Имя файла определяется на основе переменной `className` (если есть) с расширением `.kt`, иначе используется имя шаблона.
*   **Копирование в буфер обмена:** Кнопка для копирования отрендеренного результата в буфер обмена.
*   **Настройки пути сохранения:** В экран настроек добавлено поле для указания пути сохранения с возможностью выбора папки через файловый диалог.

**Исправления и улучшения:**

*   **Исправление навигации "Вверх" по папкам:**
    *   **Проблема:** Изначально навигация "вверх" работала некорректно или сбивалась, а иконка была идентична кнопке "назад", что вызывало путаницу.
    *   **Решение:**
        *   Логика `navigateUp()` в `TemplatesViewModel` была переработана для большей надежности с использованием `expect`/`actual` функции `getParentPath()` для кросс-платформенного получения родительского пути.
        *   Иконка кнопки "Вверх" изменена на `Icons.Default.ArrowUpward` для лучшей визуальной дифференциации.
*   **Сохранение состояния при повторном входе:**
    *   **Проблема:** При выходе из инструмента "Шаблоны" и повторном входе, состояние навигации (текущая папка) сбрасывалось.
    *   **Решение:** Изменен способ инъекции `TemplatesViewModel` в `TemplatesScreen` с `koinViewModel` на `koinInject()`. Это гарантирует использование единственного экземпляра `ViewModel` (синглтона), сохраняющего свое состояние на протяжении всего жизненного цикла приложения.
*   **Удаление File Watcher:** По запросу пользователя, функционал отслеживания изменений в файлах шаблонов был полностью удален, так как требовалось состояние на момент запуска.

---

### 2. Инструмент "Мульти-генератор" (Batch Generator)

**Задача:** Генерировать несколько файлов из одного шаблона, используя список входных элементов.

**Реализованный функционал:**

*   **Новый инструмент:** Добавлен как отдельный пункт на главном экране инструментов.
*   **Выбор шаблона:** Выпадающий список для выбора `.vm` шаблона (рекурсивный поиск по папке `Templates`).
*   **Список элементов для генерации:**
    *   Поле ввода и кнопка "Добавить" для ручного ввода элементов.
    *   Кнопка "Импорт" с файловым диалогом для загрузки списка элементов из текстового файла (каждая строка файла = новый элемент).
    *   Кнопка "Удалить" для каждого элемента в списке.
*   **Переменные шаблона:**
    *   Для каждой переменной, найденной в шаблоне (кроме `itemName`), генерируется поле ввода.
    *   Значения по умолчанию из `## @default(...)` подставляются.
*   **Генерация:** Кнопка "Сгенерировать" инициирует процесс:
    *   Для каждого элемента из списка (`itemName`) шаблон рендерится отдельно.
    *   Имя файла для каждого генерируемого файла определяется как `${itemName}Screen.kt` (жестко заданная логика).
    *   Все сгенерированные файлы отображаются в едином логе.
*   **Сохранение:** Кнопка "Сохранить все" сохраняет каждый сгенерированный файл в указанную в настройках папку, с учетом структуры пакетов (если `packageName` присутствует).
*   **Обработка ошибок:** Добавлена детальная обработка ошибок с выводом сообщений в лог (например, "Шаблон не выбран", "Список элементов пуст", "Ошибка чтения шаблона").

---

### 3. Инструмент "Генератор Списков" (List Generator)

**Задача:** Генерировать *один* файл из шаблона, используя список входных элементов как переменную-список.

**Реализованный функционал:**

*   **Новый инструмент:** Добавлен как отдельный пункт на главном экране инструментов.
*   **Динамический UI на основе шаблона:**
    *   **Парсинг переменных:** При выборе шаблона, приложение анализирует его содержимое и извлекает все переменные.
    *   **Директива `## @list(variableName)`:** Введена новая директива для явного указания, какая переменная в шаблоне должна быть списком.
    *   **Динамическая генерация полей:**
        *   Для переменных, помеченных как `@list`, генерируется полноценный редактор списка (с добавлением, удалением, импортом).
        *   Для остальных переменных генерируются обычные поля ввода.
    *   **Поле "Имя переменной для списка":** Позволяет пользователю указать, под каким именем список элементов будет доступен в шаблоне (по умолчанию `itemsList`).
*   **Генерация:** Кнопка "Сгенерировать" инициирует процесс:
    *   Весь список элементов передается в Velocity-контекст как одна переменная (с именем, указанным пользователем).
    *   Шаблон рендерится один раз.
    *   Результат отображается в поле вывода.
*   **Сохранение:** Кнопка "Сохранить" сохраняет единственный сгенерированный файл.
    *   Имя файла определяется с помощью директивы `## @filename("MyFileName.txt")` из шаблона.
    *   Путь сохранения берется из настроек, с учетом структуры пакетов.
*   **Обработка ошибок:** Добавлена детальная обработка ошибок с выводом сообщений в лог.

---

**Ключевые архитектурные решения:**

*   **Kotlin Multiplatform (KMP):** Активно используется `expect`/`actual` механизм для абстрагирования платформозависимых операций (доступ к файловой системе, рендеринг Velocity).
*   **Jetpack Compose Desktop:** Используется для построения всего пользовательского интерфейса.
*   **Koin:** Применяется для управления зависимостями, обеспечивая синглтон-скоуп для `ViewModel` там, где это необходимо для сохранения состояния.
*   **Velocity Engine:** Используется для рендеринга шаблонов.
*   **`VelocityParser`:** Кастомный парсер на основе регулярных выражений для извлечения переменных, значений по умолчанию и директив (`@filename`, `@list`) из шаблонов.

---
Надеюсь, эта документация будет полезна для будущих агентов!